inf=math.huge
isfinite=function(x) return inf~=x and -inf~=x and x==x end 
id=function(x) if isfinite(x) then return x else return 0 end end
qfa=function(f,a,b,patience,epsz,wanna_print)
  a=a or 0
  b=b or 1
  patience=patience or 10
  epsz=epsz or 1e-12
  wanna_print=wanna_print or false
  local _qfc={
  0.0051282051282051282051282051282051281759,
  0.048699387295088238550645108490909649756,
  0.097820391676052159128537348618992594511,
  0.13966507849560431803157492542792136238,
  0.17560578900106674676537594695346634661,
  0.20205146748238357363676732792567368935,
  0.21888151163057340179839439673523336642,
  0.22429633858205286776715348143919572482,
  0.21888151163057340179839439673523336641,
  0.20205146748238357363676732792567368937,
  0.17560578900106674676537594695346634660,
  0.13966507849560431803157492542792136237,
  0.097820391676052159128537348618992594505,
  0.048699387295088238550645108490909649754,
  0.0051282051282051282051282051282051281921
  }
  local _qfxx={
  -1.0000000000000000000000000000000000000,
  -0.99371220989324258353314824194737869715,
  -0.97492791218182360701813168299393121723,
  -0.94388333030836756289526360715103662152,
  -0.90096886790241912623610231950744505116,
  -0.84672419922828416835277581626296527151,
  -0.78183148246802980870844452667405775024,
  -0.70710678118654752440084436210484903929,
  -0.62348980185873353052500488400423981064,
  -0.53203207651533656355763036723037073017,
  -0.43388373911755812047576833284835875461,
  -0.33027906195516708177487761259657237031,
  -0.22252093395631440428890256449679475947,
  -0.11196447610330785846870593527202420326,
  0,
  0.11196447610330785846870593527202420326,
  0.22252093395631440428890256449679475947,
  0.33027906195516708177487761259657237031,
  0.43388373911755812047576833284835875461,
  0.53203207651533656355763036723037073017,
  0.62348980185873353052500488400423981063,
  0.70710678118654752440084436210484903928,
  0.78183148246802980870844452667405775023,
  0.84672419922828416835277581626296527151,
  0.90096886790241912623610231950744505116,
  0.94388333030836756289526360715103662152,
  0.97492791218182360701813168299393121723,
  0.99371220989324258353314824194737869715,
  1.0000000000000000000000000000000000000
  }
  local _qfcc={
  0.0012771392081736909323116219667943805384,
  0.012261863082965059183757260672587997397,
  0.025073542949876119982835702556885437729,
  0.037003488124485205952410988595758198919,
  0.048714184513998659016006832920198121119,
  0.059671722500291530510800360039061795198,
  0.069971720188124901715360725785693207337,
  0.079324399141810206291234242539439122598,
  0.087731808647660728388301226283541406525,
  0.094993231127670812935868864274475598423,
  0.10109644009839900606731621967353236674,
  0.10589618899078746036382490403487686430,
  0.10939348026402093482773831077366493146,
  0.11148767663607657022825919082719761136,
  0.11220622905131822720794709811258591222,
  0.11148767663607657022825919082719761137,
  0.10939348026402093482773831077366493147,
  0.10589618899078746036382490403487686430,
  0.10109644009839900606731621967353236673,
  0.094993231127670812935868864274475598407,
  0.087731808647660728388301226283541406539,
  0.079324399141810206291234242539439122596,
  0.069971720188124901715360725785693207342,
  0.059671722500291530510800360039061795189,
  0.048714184513998659016006832920198121113,
  0.037003488124485205952410988595758198910,
  0.025073542949876119982835702556885437708,
  0.012261863082965059183757260672587997395,
  0.0012771392081736909323116219667943805590
  }
  if a==b then return 0 end
  if a>b then return -qfa(f,b,a,patience,epsz,wanna_print) end
  if -inf==a and inf==b then
    return qfa(function(x) return f(x/(1-x^2))*(1+x^2)/(1-x^2)^2 end,
               -1,1,patience,epsz,wanna_print)
  end
  if isfinite(a) and inf==b then
    return qfa(function(x) return f(a+x/(1-x))/(1-x)^2 end,
	       0,1,patience,epsz,wanna_print)
  end
  if -inf==a and isfinite(b) then
    return qfa(function(x) return f(b-x/(1-x))/(1-x)^2 end,
	       0,1,patience,epsz,wanna_print)
  end
  local function F(x) return id(f(id(x))) end
  if wanna_print then
    print("a",a,"b",b,"patience",patience)
  end
  local m=(a+b)/2
  local h=(b-a)/2
  local H=0
  local L=0
  for i=1,#_qfxx do
    H=H+F(m+h*_qfxx[i])*_qfcc[i]
    if 1==i%2 then
      L=L+F(m+h*_qfxx[i])*_qfc[(i+1)/2]
    end
  end
  H=h*H
  L=h*L
  --print("H-L",H-L)
  if epsz>math.abs(H-L) then
    return H
  end
  if patience>0 then
    return qfa(F,a,m,patience-1,epsz,wanna_print) +
           qfa(F,m,b,patience-1,epsz,wanna_print)
  end
  return H
end
qqfa=function(f,a,b,c,d,patience,epsz,wanna_print)
  a=a or 0
  b=b or 1
  c=c or 0
  d=d or 1
  patience=patience or 6
  epsz=epsz or 1e-12
  wanna_print=wanna_print or false
  return qfa(function(x)return qfa(function(y)return f(x,y) end,
                                   c,d,patience,epsz,wanna_print) end,
             a,b,patience,epsz,wanna_print)
end
qqqfa=function(f,a,b,c,d,e,ff,patience,epsz,wanna_print)
  a=a or 0
  b=b or 1
  c=c or 0
  d=d or 1
  e=e or 0
  ff=ff or 1
  patience=patience or 5
  epsz=epsz or 1e-12
  wanna_print=wanna_print or false
  return qfa(function(x)return qfa(function(y)return qfa(function(z)return f(x,y,z) end,
                                                         e,ff,patience,epsz,wanna_print)end,
                                   c,d,patience,epsz,wanna_print)end,
             a,b,patience,epsz,wanna_print)
end

--[[	Sample run.
> =qfa(function(x)return qfa(function(y)if 1>x^2+y^2 then return 1 else return 0 end end,-1,1,60,1e-16)end,-1,1,20,1e-16)-math.pi
-7.4606987254811e-14
> =qfa(function(x)return 1/(1+x^2) end,-inf,inf,60,1e-16)-math.pi
0.0
> =qfa(function(x)return math.sqrt(1-x^2)end,-1,1,30,1e-16)-math.pi/2
0.0
]]
